---
title: 'Data Viz.: Homework 7'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
library(tidyverse)
library(readxl)
library(httr)
library(plotly)
library(RColorBrewer)
```

## Continuous variable

### Import & format data
```{r}
GET('http://www.africapolis.org/download/Africapolis_agglomeration_2015.xlsx', 
    write_disk(africapolis_impt <- tempfile(fileext = ".xls")))
```

```{r pressure, echo=FALSE}
afr_cities <- read_xlsx(africapolis_impt, 
               skip = 15, 
               col_types = c("text", "text", "text", rep("numeric", 7), 
                             "text", rep("numeric", 8)), 
               na = c('-', 'M', ''))

afr_cities <- afr_cities %>%
  rename(closest_metro = `Closest Metro`, 
         dist_to_metro = `Distance to metro`)
```

```{r}
# ggplot(afr_cities, aes(x = Population_2015, y = Builtup)) +
#   geom_point()
```

```{r}
hub_cities <- afr_cities %>%
  drop_na(closest_metro) %>%
  group_by(closest_metro) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  head(5)

hub_cities
```
```{r fig.height= 6, fig.width=4}
test <- afr_cities %>%
  filter(closest_metro %in% hub_cities$closest_metro) %>%
  filter(dist_to_metro > 0) %>%
  filter(Population_2015 < 500000)


ggplot(test, aes(x = dist_to_metro, y = Population_2015)) +
  theme_classic() +
  scale_y_log10(labels = scales::comma) +
  geom_point(color = "lightblue") +
  geom_smooth(method = 'lm', formula = y ~ splines::bs(x, 3), se = FALSE, color = "steelblue") +
  facet_grid(rows = vars(factor(closest_metro)))

?geom_smooth
```

```{r fig.height= 6, fig.width=4}
# ggplot(test, aes(x = Population_2015, y = Builtup)) +
#   theme_classic() +
#   scale_y_continuous(labels = scales::comma) +
#   scale_x_continuous(labels = scales::comma) +
#   geom_point() +
#   geom_smooth(method = 'lm', formula = y ~ splines::bs(x, 3), se = FALSE) +
#   facet_grid(rows = vars(factor(closest_metro)))
```

```{r}
# plot_ly(data = plot_data, x = ~prestg105plus, y = ~sppres105plus, 
#         height = 500, width = 700) %>%
#     
#         add_trace(type = "scatter", mode = "markers", hoverinfo = 'text',
#                   text = paste("R's prestige: ", plot_data$prestg105plus, "<br>", 
#                            "Spouse's prestige: ", plot_data$sppres105plus),
#                   marker = list(size = 5, 
#                                 color = wes_palette("Zissou1")[1],
#                                 opacity = .33), 
#                   showlegend = FALSE) %>%
#     
#         add_trace(x = ~prestg105plus, y = fitted(fit), mode = "lines", 
#                   name = "Smooth", 
#                   line = list(width = 2, 
#                               color = wes_palette("Zissou1")[4])) %>% etc etc


# us_states_long <- gather(us_states, race, proportion, -State,-TotalPop)
# 
# head(us_states_long)
# 
# states=unique(us_states$State)
# 
# head(states)
# bl_pops <- matrix(NA, length(states))
# for (i in 1:length(states)) {
# bl_pops[i] <- rep(x=states[i], times=as.integer(us_states_long[us_states_long$State==states[i] && 
#                                                      us_states_long$race=='Black.Population',4]*10))
# }
```

```{r}
color <- brewer.pal(4, "Set1")


plots <- list()
idx <- 0
for (hub in hub_cities$closest_metro){
  idx <- idx + 1
  
  a <- list(
    text = hub_cities$closest_metro[idx],
    xref = "paper",
    yref = "paper",
    yanchor = "bottom",
    xanchor = "center",
    align = "center",
    x = 0.5,
    y = 1,
    showarrow = FALSE
  )
  
  data <- afr_cities %>%
    filter(closest_metro == hub) %>%
    arrange(desc(dist_to_metro))
  
  fit <- lm(Builtup ~ dist_to_metro, data = data)

  p <- plot_ly(data, x = ~dist_to_metro, y = ~Builtup) %>%
    
       add_trace(type = "scatter", mode = "markers", hoverinfo = 'text',
                  text = paste("Name of town: ", data$Agglomeration_Name, "<br>", 
                           "Altitude: ", data$Altitude),
                  marker = list(size = 5, 
                                color = color[1],
                                opacity = .33), 
                  showlegend = FALSE) %>%
     
       add_trace(x = ~dist_to_metro, y = fitted(fit), mode = "lines",
                  name = "",
                  line = list(width = 2,
                              color = color[2])) %>%

      layout(yaxis = list(title = "",
                          type = 'log',
                        zeroline = FALSE), 
           
           xaxis = list(title = "Distance from Closest Metro",
                      zeroline = FALSE), 
           
           annotations = a)   #%>%
  
  plots <- c(plots, list(p)) 

}
    
subplot(plots, nrows = nrow(hub_cities), shareX = TRUE, titleY = TRUE, titleX = TRUE) 
```

#Categorical Variable
From https://www.governing.com/gov-data/residential-racial-segregation-metro-areas.html 

##Reading and formating the data
```{r}
GET('http://images.centerdigitaled.com/documents/segregation-national-download.csv', 
    write_disk(us_cities_impt <- tempfile(fileext = ".csv")))

us_cities <- read.csv(us_cities_impt)

#Separating city and state
us_cities <- separate(data = us_cities, col = MSA, into = c("City", "State"), sep = ",")
#Cities are on the border of two states and will be removed
us_cities <- us_cities[!grepl("-",us_cities$State),]
#Keeping only columns of interest
us_states <- us_cities[,c("State", "Black.Population", "White.Population..Non.Hispanic.", "Hispanic.Population", "Asian.Population")]

#Grouping race populations by state
us_states <- aggregate(.~ State, us_states, FUN=sum)
#Calculate total sample population of each state
us_states$TotalPop <- apply(us_states[-1],1,sum)

#Convert counts to percentages
us_states$Black.Population <- round(us_states$Black.Population/us_states$TotalPop *100, 1)
us_states$White.Population..Non.Hispanic. <- round(us_states$White.Population..Non.Hispanic./us_states$TotalPop*100, 1)
us_states$Hispanic.Population <- round(us_states$Hispanic.Population/us_states$TotalPop*100, 1)
us_states$Asian.Population <- round(us_states$Asian.Population/us_states$TotalPop*100, 1)

```

##Plotting racial breakdown of states from population samples
```{r}
color <- brewer.pal(4, "Set1")
plot_ly(us_states, x = ~State, y = ~Black.Population, 
        type = 'bar',
        name = 'Black Population',
        marker = list(color = color[1]),
        text = paste("<b>State:</b>", us_states$State, "<br><b>Sample Population:</b>", prettyNum(us_states$TotalPop,big.mark=",",scientific=FALSE)),
        hoverinfo = "text+y") %>%
  add_trace(y = ~White.Population..Non.Hispanic., 
            name = 'White Population',
            marker=list(color = color[2])) %>%
  add_trace(y = ~Hispanic.Population, 
            name = 'Hispanic Population',
            marker=list(color = color[3])) %>%
  add_trace(y = ~Asian.Population, 
            name = 'Asian Population',
            marker=list(color = color[4])) %>%
  layout(margin = list(t = 80),
         barmode = 'stack', 
         annotations = list(text = "Racial Breakdown of Urban Areas in US States", 
                            showarrow = FALSE, 
                            font = list(size = 19), 
                            x = 0.5, 
                            xref = "paper", 
                            xanchor = "center", 
                            y = 1.2, 
                            yref = "paper"),
         yaxis = list(title = "Percent of Population",
                      ticksuffix = "%",
                      zeroline = FALSE))   %>%
  add_annotations(text = paste0("Based on Data from 273 Cities in 43 States"), 
                  showarrow = FALSE, 
                  font = list(size = 16), 
                  x = 0.5, 
                  xref = "paper", 
                  xanchor = "center", 
                  y = 1.12, 
                  yref = "paper")
```

##Looking at a sample of 5 random states
Because there is data from 43 states, we decided to choose five random states to look at. Using this subset, we created a second chart below, which is easier to interpret.
```{r}
set.seed(1)
index <- sample(1:nrow(us_states), 5)
us_sub <- us_states[index,]

plot_ly(us_sub, x = ~State, y = ~Black.Population, 
        type = 'bar',
        name = 'Black Population',
        marker = list(color = color[1]),
        text = paste("<b>State:</b>", us_sub$State, "<br><b>Sample Population:</b>", prettyNum(us_sub$TotalPop,big.mark=",",scientific=FALSE)),
        hoverinfo = "text+y") %>%
  add_trace(y = ~White.Population..Non.Hispanic., 
            name = 'White Population',
            marker=list(color = color[2])) %>%
  add_trace(y = ~Hispanic.Population, 
            name = 'Hispanic Population',
            marker=list(color = color[3])) %>%
  add_trace(y = ~Asian.Population, 
            name = 'Asian Population',
            marker=list(color = color[4])) %>%
  layout(margin = list(t = 80),
         barmode = 'stack', 
         annotations = list(text = "Racial Breakdown of Urban Areas in Five US States", 
                            showarrow = FALSE, 
                            font = list(size = 19), 
                            x = 0.5, 
                            xref = "paper", 
                            xanchor = "center", 
                            y = 1.2, 
                            yref = "paper"),
         yaxis = list(title = "Percent of Population",
                      ticksuffix = "%",
                      zeroline = FALSE))

```

